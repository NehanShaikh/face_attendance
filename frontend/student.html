<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f4f7fb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    h2 {
      font-weight: 600;
      color: #2c3e50;
      text-align: center;
      margin: 20px 0;
    }
    .section {
      display: none;
    }
    
    /* FIXED TABLE STYLES */
    .table-container {
      overflow-x: auto;
      max-width: 100%;
      border-radius: 8px;
    }
    .table {
      min-width: 800px; /* Minimum width for all columns */
      width: 100%;
      margin-bottom: 0;
    }
    .table th {
      text-align: center;
      background: #4e73df;
      color: #fff;
      font-weight: 500;
      white-space: nowrap;
      padding: 12px 8px;
    }
    .table td {
      text-align: center;
      vertical-align: middle;
      padding: 10px 8px;
      word-wrap: break-word;
    }
    tr:hover td {
      background: #eef3ff;
    }
    
    /* Fixed column widths */
    .table th:nth-child(1), .table td:nth-child(1) { width: 15%; } /* Attendance ID */
    .table th:nth-child(2), .table td:nth-child(2) { width: 15%; } /* Student ID */
    .table th:nth-child(3), .table td:nth-child(3) { width: 20%; } /* Name */
    .table th:nth-child(4), .table td:nth-child(4) { width: 25%; } /* Subject */
    .table th:nth-child(5), .table td:nth-child(5) { width: 25%; } /* Timestamp */

    .download-card {
      background: #e7f3ff;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      border-left: 4px solid #28a745;
    }
    .download-btn {
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s ease;
    }
    .download-btn:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    .step {
      margin: 8px 0;
      padding: 8px;
      background: white;
      border-radius: 5px;
      border-left: 3px solid #28a745;
    }
    
    /* Face Tools Section Styles */
    .download-section {
      background: #e7f3ff;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid #007bff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .download-section h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }
    
    .download-section p {
      color: #555;
      margin-bottom: 15px;
    }
    
    .instructions {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.8);
      border-radius: 8px;
    }
    
    .instructions h4 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container mt-4">
    <h2 class="text-center mb-4">üéì Student Dashboard</h2>
    <div class="d-flex justify-content-end mb-3">
      <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
    </div>

    <!-- Register Student -->
<div class="mb-4">
  <button id="openFormBtn" class="btn btn-primary">‚ûï Register Student</button>
  <div id="studentFormContainer" style="display:none; margin-top:20px;">
    <div class="card shadow p-3">
      <h4>Student Registration</h4>
      <form id="studentForm">
        <input type="text" id="sname" placeholder="Name" class="form-control mb-2" required>
        <input type="text" id="sroll" placeholder="Roll Number" class="form-control mb-2" required>
        <input type="text" id="sclass" placeholder="Class" class="form-control mb-2" required>
        <input type="email" id="semail" placeholder="Email" class="form-control mb-2" required>
        <input type="text" id="sphone" placeholder="Phone" class="form-control mb-2" required>
        <button type="submit" class="btn btn-success">Confirm Registration</button>
        <button type="button" id="closeFormBtn" class="btn btn-secondary">Cancel</button>
      </form>
      <div id="studentMsg" class="mt-2"></div>
    </div>
  </div>
</div>

    <!-- Face Registration Instructions (shown after successful registration) -->
    <div id="faceRegistrationSection" style="display: none;" class="download-card">
      <h4>üì∏ Complete Your Face Registration</h4>
      <p>Your basic information is registered. Now you need to register your face for attendance:</p>
      
      <button class="download-btn" onclick="downloadRegistrationTool()">
        üì• Download Face Registration Tool
      </button>
      
      <div class="instructions mt-3">
        <h5>üìã How to complete face registration:</h5>
        <div class="step">1. Download and run the tool above</div>
        <div class="step">2. Enter your name exactly as: <strong id="registeredName"></strong></div>
        <div class="step">3. Follow on-screen instructions to capture your face</div>
        <div class="step">4. Your face data will be saved to the system</div>
        <div class="step">5. You're now ready for automatic attendance!</div>
      </div>
      
      <p class="mt-3"><small>üí° <strong>Important:</strong> Use the same name you registered with above.</small></p>
    </div>

    <!-- Navigation Buttons -->
    <div class="d-flex justify-content-center mb-4 flex-wrap">
      <button class="btn btn-primary mx-2 mb-2" onclick="showSection('attendance')">‚úÖ My Attendance</button>
      <button class="btn btn-info mx-2 mb-2" onclick="showSection('timetable')">üìÖ My Timetable</button>
      <button class="btn btn-warning mx-2 mb-2" onclick="showSection('faceTools')">üé≠ Face Tools</button>
    </div>

    <!-- Attendance Table -->
    <!-- FIXED ATTENDANCE SECTION -->
    <div id="attendance" class="section card shadow p-3 mb-4">
      <h4 class="mb-3">‚úÖ My Attendance</h4>
      <div class="table-container"> <!-- Added container for horizontal scroll -->
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Attendance ID</th>
              <th>Student ID</th>
              <th>Name</th>
              <th>Subject</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody id="attendanceTable"></tbody>
        </table>
      </div>
    </div>
  </div>

    <!-- Timetable Table -->
    <div id="timetable" class="section card shadow p-3 mb-4">
  <h4 class="mb-3">üìÖ My Timetable</h4>
  <div class="table-responsive"> <!-- Added Bootstrap responsive wrapper -->
    <table class="table table-striped table-hover">
      <thead class="table-primary">
        <tr>
          <th>Day</th>
          <th>Subject</th>
          <th>Start Time</th>
          <th>End Time</th>
        </tr>
      </thead>
      <tbody id="timetableTable">
    </div>
  </div>

    <!-- Face Recognition Tools Section -->
    <div id="faceTools" class="section card shadow p-3 mb-4">
      <h4 class="mb-3">üé≠ Face Recognition Tools</h4>
      
      <div class="download-section">
        <h3>üë§ Student Registration Tool</h3>
        <p>Use this tool to register new students' faces in the system</p>
        <button class="download-btn" onclick="downloadRegistrationTool()">
          üì• Download Registration Tool
        </button>
        <div class="instructions">
          <h4>üìã How to use:</h4>
          <div class="step">1. Download and run the tool</div>
          <div class="step">2. Enter student name when prompted</div>
          <div class="step">3. Follow on-screen instructions to capture face images</div>
          <div class="step">4. Facial data will be saved to the online system</div>
          <div class="step">5. Student is now ready for face recognition attendance</div>
        </div>
      </div>

      <div class="download-section">
    <h3>‚ùì Support & Documentation</h3>
    
    <button class="download-btn" onclick="downloadUserManual()" style="background: #28a745;">
        üìñ Download User Manual
    </button>
    
    <button class="download-btn" onclick="downloadSupportGuide()" style="background: #17a2b8;">
        üîß Download Support Guide
    </button>
    
    <button class="download-btn" onclick="contactSupport()" style="background: #dc3545;">
        üìû Contact Support
    </button>
    
    <div class="instructions mt-3">
        <h4>üìö Documentation:</h4>
        <div class="step">‚Ä¢ <strong>User Manual</strong> - Complete setup and usage guide</div>
        <div class="step">‚Ä¢ <strong>Support Guide</strong> - Troubleshooting and FAQs</div>
        <div class="step">‚Ä¢ <strong>Contact Support</strong> - Email for personalized help</div>
    </div>
    </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "student.html";
    }

    // ======================
    // üéØ Download Functions
    // ======================
    function downloadRegistrationTool() {
      // Replace with your actual download link
      window.open('https://drive.google.com/file/d/17cB5EvS95-7OUdei4UEB_Ifx9EmhDFZU/view?usp=sharing', '_blank');
      alert('Face Registration Tool downloaded! Run it and enter your name to complete registration.');
    }

    function downloadUserManual() {
    // Replace with your actual Google Drive PDF link
    window.open('https://drive.google.com/file/d/1Glty7CJDjsVXlIP2fSCHhcWl2lo978fR/view?usp=sharing', '_blank');
    alert('üìñ User Manual downloaded! This PDF contains complete instructions for using the Face Recognition System.');
}

function downloadSupportGuide() {
    // Replace with your actual Google Drive PDF link
    window.open('https://drive.google.com/file/d/171rLZ9l1sw6yzSvvEMKKm_qVVkQpnPzD/view?usp=sharing', '_blank');
    alert('üîß Support Guide downloaded! This PDF contains troubleshooting and FAQ information.');
}

function contactSupport() {
    window.location.href = 'mailto:adscem2025@gmail.com?subject=Support Request - Face Recognition Attendance System&body=Hello Support Team,%0D%0A%0D%0AI need assistance with the Face Recognition Attendance System.%0D%0A%0D%0AIssue Description:%0D%0A%0D%0AThank you.';
}
  
    // ======================
// üéØ Open/Close Student Form
// ======================
document.getElementById("openFormBtn").addEventListener("click", () => {
  document.getElementById("studentFormContainer").style.display = "block";
});

document.getElementById("closeFormBtn").addEventListener("click", () => {
  document.getElementById("studentFormContainer").style.display = "none";
});

// ======================
// üìå Student Registration
// ======================
document.getElementById("studentForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const name = document.getElementById("sname").value.trim();
  const roll = document.getElementById("sroll").value.trim();
  const sclass = document.getElementById("sclass").value.trim();
  const email = document.getElementById("semail").value.trim();
  const phone = document.getElementById("sphone").value.trim();

  // Show confirmation popup
  const isConfirmed = confirm(`Are you sure you want to register this student?\n\nName: ${name}\nRoll Number: ${roll}\nClass: ${sclass}\nEmail: ${email}\nPhone: ${phone}`);
  
  if (!isConfirmed) {
    return; // Stop if user cancels
  }

  try {
    const res = await fetch("https://face-attendance-9vis.onrender.com/students", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json", 
        "Authorization": "Bearer " + token 
      },
      body: JSON.stringify({ 
        name, 
        roll_number: roll, 
        class_name: sclass, 
        email, 
        phone 
      })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      // Show success message and face registration instructions
      document.getElementById("studentMsg").innerHTML = `
        <div class="alert alert-success">
          ‚úÖ Student registered successfully!<br>
          <strong>Student ID:</strong> ${data.student_id}
        </div>
      `;
      
      // Show face registration section
      document.getElementById("registeredName").textContent = name;
      document.getElementById("faceRegistrationSection").style.display = "block";
      
      // Clear form and close
      document.getElementById("studentForm").reset();
      document.getElementById("studentFormContainer").style.display = "none";
    } else {
      document.getElementById("studentMsg").innerHTML = `
        <div class="alert alert-danger">
          ‚ùå Error: ${data.error || data.message}
        </div>
      `;
    }
  } catch (err) {
    document.getElementById("studentMsg").innerHTML = `
      <div class="alert alert-danger">
        ‚ùå Request failed: ${err.message}
      </div>
    `;
  }
});

// ======================
// üìå Section Navigation
// ======================
function showSection(sectionId) {
  document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");
  document.getElementById(sectionId).style.display = "block";

  if (sectionId === "attendance") fetchMyAttendance();
  if (sectionId === "timetable") fetchTimetable();
}


    // ======================
    // üìå Fetch Attendance
    // ======================
    async function fetchMyAttendance() {
      try {
        const res = await fetch("https://face-attendance-9vis.onrender.com/student/attendance", { 
          headers: { "Authorization": "Bearer " + token }
        });
        const records = await res.json();
        let rows = "";
        if (records.length === 0) {
          rows = `<tr><td colspan="5" class="text-center">No attendance records found</td></tr>`;
        } else {
          records.forEach(r => {
            rows += `
              <tr>
                <td>${r.attendance_id}</td>
                <td>${r.student_id}</td>
                <td>${r.student_name}</td>
                <td>${r.subject_name || "N/A"}</td>
                <td>${new Date(r.timestamp).toLocaleString()}</td>
              </tr>
            `;
          });
        }
        document.getElementById("attendanceTable").innerHTML = rows;
      } catch (err) {
        console.error("‚ùå Error fetching attendance:", err);
        document.getElementById("attendanceTable").innerHTML = `<tr><td colspan="5" class="text-center">Error loading attendance</td></tr>`;
      }
    }

    // ======================
    // üìå Fetch Timetable
    // ======================
    async function fetchTimetable() {
      try {
        const res = await fetch("https://face-attendance-9vis.onrender.com/student/timetable", { 
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        let rows = "";
        if (data.length === 0) {
          rows = `<tr><td colspan="4" class="text-center">No timetable found</td></tr>`;
        } else {
          data.forEach(t => rows += `<tr><td>${t.day}</td><td>${t.subject}</td><td>${t.start_time}</td><td>${t.end_time}</td></tr>`);
        }
        document.getElementById("timetableTable").innerHTML = rows;
      } catch (err) { 
        console.error("‚ùå Error fetching timetable:", err);
        document.getElementById("timetableTable").innerHTML = `<tr><td colspan="4" class="text-center">Error loading timetable</td></tr>`;
      }
    }

    // ======================
    // üìå Logout
    // ======================
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "pipeline.html";
    }

    // Load initial data
    fetchMyAttendance();
    fetchTimetable();
    
    // Show attendance by default
    showSection('attendance');
  </script>
</body>
</html>
